
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard — Blissful Weddings (Gold Glass)</title>

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* --- Base / Reset --- */
    :root{
      --gold: #d4a373;
      --gold-weak: rgba(212,163,115,0.12);
      --bg-dark: #0f0f0f;
      --panel-dark: rgba(20,20,20,0.55);
      --glass-border: rgba(255,255,255,0.06);
      --text: #f3f3f3;
      --muted: #bdbdbd;
    }

    * {
      box-sizing: border-box;
      margin:0;
      padding:0;
      -webkit-font-smoothing:antialiased;
    }

    html,body { height:100%; }

    body {
      font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto;
      background: linear-gradient(180deg, #080808 0%, #0f0f0f 100%);
      color: var(--text);
      min-height:100vh;
      transition: background 350ms ease, color 350ms ease;
      padding: 36px;
      overflow: hidden;
    }

    .app {
      height: calc(100vh - 72px);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .topbar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 18px 22px;
      border-radius: 14px;
      backdrop-filter: blur(45px) saturate(150%);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border: 1px solid var(--glass-border);
      box-shadow: 0 8px 30px rgba(7,7,7,0.6);
    }

    .brand {
      display:flex;
      gap:14px;
      align-items:center;
    }

    .logo {
      width:46px; height:46px; border-radius:10px;
      background: linear-gradient(135deg, rgba(255,255,255,0.06), var(--gold-weak));
      display:flex; align-items:center; justify-content:center;
      font-family: "Playfair Display", serif;
      color: var(--gold);
      font-weight:700;
      box-shadow: 0 6px 24px rgba(212,163,115,0.06);
      border:1px solid rgba(255,255,255,0.03);
    }

    .title {
      font-family: "Playfair Display", serif;
      font-size: 1.25rem;
      color: var(--gold);
    }

    .controls {
      display:flex;
      gap:10px;
      align-items:center;
    }

    .counter {
      padding:8px 12px;
      border-radius:10px;
      background: rgba(212,163,115,0.12);
      color: var(--gold);
      font-weight:600;
      border:1px solid rgba(212,163,115,0.08);
    }

    /* pill toggle (iOS style) */
    .theme-toggle {
      display:flex;
      align-items:center;
      gap:10px;
    }

    .toggle-track {
      width:62px;
      height:34px;
      background: rgba(255,255,255,0.06);
      border-radius:999px;
      padding:4px;
      position:relative;
      display:inline-flex;
      align-items:center;
      cursor:pointer;
      border:1px solid rgba(255,255,255,0.03);
      transition: background 220ms ease;
      backdrop-filter: blur(18px);
    }

    .toggle-knob {
      width:26px;
      height:26px;
      border-radius:50%;
      background: linear-gradient(180deg, #fff, #f1e9d8);
      transform: translateX(0);
      transition: transform 260ms cubic-bezier(.2,.9,.3,1), box-shadow 220ms;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45), inset 0 -2px 4px rgba(0,0,0,0.08);
    }

    .toggle-track.active {
      background: linear-gradient(90deg, rgba(212,163,115,0.18), rgba(212,163,115,0.08));
    }

    .toggle-track.active .toggle-knob {
      transform: translateX(28px);
    }

    /* group right controls so layout never breaks */
    .right-actions {
      display:flex;
      align-items:center;
      gap:14px;
      flex-shrink: 0; /* prevents squeezing left panel */
    }

    /* logout button styling */
    .logout-btn {
      padding:8px 14px;
      border-radius:10px;
      background: rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.05);
      color: var(--gold);
      text-decoration:none;
      font-weight:600;
      font-size:0.9rem;
      transition:0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.12);
      transform: translateY(-2px);
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
    }

    /* action buttons */
    .btn {
      padding:10px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      background: rgba(255,255,255,0.03);
      color:var(--text);
      border:1px solid rgba(255,255,255,0.03);
    }

    .btn:hover { transform: translateY(-2px); }

    .export-btn {
      padding:8px 10px;
      border-radius:10px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.04);
    }

    /* --- CONTENT GRID --- */
    .content {
      display:flex;
      gap:18px;
      height: calc(100% - 86px);
    }

    .panel {
      width: 360px;
      border-radius: 14px;
      padding: 18px;
      backdrop-filter: blur(45px) saturate(160%);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow: 0 12px 40px rgba(10,6,6,0.6);
    }

    .search { display:flex; gap:8px; align-items:center; }

    .search input {
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      background: rgba(0,0,0,0.35);
      color:var(--text);
    }

    .select {
      padding:12px;
      border-radius:10px;
      border:none;
      background: rgba(0,0,0,0.35);
      color:var(--text);
      width:100%;
    }

    .export-row {
      display:flex;
      gap:8px;
      justify-content:space-between;
      align-items:center;
    }

    /* right - messages grid */
    .grid-wrap {
      flex:1;
      border-radius:14px;
      padding:18px;
      backdrop-filter: blur(45px) saturate(150%);
      background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border:1px solid var(--glass-border);
      overflow:auto;
    }

    .messages-grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap:14px;
    }

    .card {
      padding:14px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
      box-shadow: 0 8px 28px rgba(3,3,3,0.45);
      cursor:pointer;
      transition: transform 160ms ease, box-shadow 160ms;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 18px 48px rgba(3,3,3,0.6);
    }

    .card h4 {
      margin-bottom:6px;
      color:var(--gold);
      font-family: "Playfair Display", serif;
    }

    .meta {
      color:var(--muted);
      font-size:0.9rem;
      margin-bottom:8px;
    }

    .card .actions {
      display:flex;
      gap:8px;
      margin-top:10px;
      align-items:center;
    }

    .small { font-size:0.9rem; color:var(--muted); }

    .delete-btn {
      background:transparent;
      border:1px solid rgba(255,255,255,0.04);
      color:var(--gold);
      padding:6px 8px;
      border-radius:8px;
      cursor:pointer;
    }

    /* modal overlay */
    .modal-overlay {
      position: fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(6,6,6,0.45);
      backdrop-filter: blur(8px);
      z-index: 9999;
    }

    .modal {
      width: min(820px, 92%);
      border-radius: 14px;
      padding: 20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.05);
      box-shadow: 0 22px 70px rgba(7,7,7,0.8);
      backdrop-filter: blur(45px) saturate(160%);
    }

    .modal .modal-head {
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      margin-bottom:12px;
    }

    .modal .modal-body {
      max-height:60vh;
      overflow:auto;
      padding-right:6px;
    }

   /* REAL iOS / macOS PURE WHITE MODE */
body.light {
  background: #fdfdfd; /* crisp apple white */
  color: #1d1d1f;      /* apple's dark text */
}

/* glass surfaces — iOS frosted, super clean */
body.light .topbar,
body.light .panel,
body.light .grid-wrap,
body.light .modal {
  background: rgba(255, 255, 255, 0.76);
  backdrop-filter: blur(30px) saturate(180%);
  border: 1px solid rgba(0, 0, 0, 0.08);
  box-shadow: 0 8px 25px rgba(0,0,0,0.06);
  color: #1d1d1f;
}

/* logo box — soft raised white tile */
body.light .logo {
  background: #ffffff;
  border: 1px solid rgba(0,0,0,0.05);
  color: var(--gold);
  box-shadow: 0 3px 10px rgba(0,0,0,0.06);
}

/* cards — iOS "sheet" look */
body.light .card {
  background: rgba(255,255,255,0.82);
  border: 1px solid rgba(0,0,0,0.06);
  box-shadow: 0 6px 18px rgba(0,0,0,0.05);
}

body.light .card:hover {
  background: #ffffff;
  box-shadow: 0 10px 28px rgba(0,0,0,0.08);
}

/* text inside cards */
body.light .meta,
body.light .small {
  color: #6e6e73; /* apple secondary text */
}

/* input fields — iOS rounded search style */
body.light .search input,
body.light .select {
  background: #f1f1f3;
  border: 1px solid rgba(0,0,0,0.08);
  color: #1d1d1f;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
}

/* iOS toggle switch */
body.light .toggle-track {
  background: #dcdcdc;
}

body.light .toggle-track.active {
  background: linear-gradient(90deg, #ffd9ae, #f6c490);
}

body.light .toggle-knob {
  background: #ffffff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.12);
}

/* logout + buttons — Cupertino buttons */
body.light .logout-btn,
body.light .btn {
  background: #f2f2f7; /* default iOS surface */
  border: 1px solid rgba(0,0,0,0.08);
  color: #1d1d1f;
}

body.light .logout-btn:hover,
body.light .btn:hover {
  background: #e5e5ea; /* subtle highlight */
  transform: translateY(-2px);
}

/* modal text */
body.light .modal-body {
  color: #1d1d1f;
}

  </style>
</head>
<script>
  // protect admin page (PHP session replacement)
  if (localStorage.getItem("adminLoggedIn") !== "true") {
    window.location.href = "login.html";
  }

  // optional: auto logout after 15 minutes
  setTimeout(() => {
    localStorage.removeItem("adminLoggedIn");
    window.location.href = "login.html";
  }, 15 * 60 * 1000);
</script>

<body>

  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="logo">B</div>
        <div>
          <div class="title">Blissful Weddings — Admin</div>
          <div class="small">Messages Dashboard</div>
        </div>
      </div>

      <div class="controls">
        <div class="right-actions">

          <div class="counter" id="counter">Total: 0</div>

          <div class="theme-toggle" title="Toggle theme">
            <div id="themeTrack" class="toggle-track" role="switch" aria-checked="false">
              <div class="toggle-knob"></div>
            </div>
          </div>

<a href="#" class="logout-btn" onclick="logout()">Logout</a>

        </div>
      </div>
    </div>

    <div class="content">

      <!-- LEFT PANEL -->
      <div class="panel">

        <div class="search">
          <input id="search" placeholder="Search by name, email, message..." />
        </div>

        <select id="sort" class="select">
          <option value="latest">Latest First</option>
          <option value="oldest">Oldest First</option>
        </select>

        <div class="export-row">
          <div style="display:flex; gap:8px;">
            <button class="btn export-btn" onclick="exportCSV()">CSV</button>
            <button class="btn export-btn" onclick="exportJSON()">JSON</button>
            <button class="btn export-btn" onclick="exportTXT()">TXT</button>
          </div>

          <div style="display:flex; gap:8px;">
            <button class="btn" id="refreshNow" title="Refresh">⟳ Refresh</button>
          </div>
        </div>

        <div style="margin-top:6px; color:var(--muted); font-size:0.9rem;">
          Auto refresh every 10s. Click a card to open message window with PDF download.
        </div>

      </div>

      <!-- RIGHT GRID -->
      <div class="grid-wrap">
        <div id="messagesGrid" class="messages-grid"></div>
      </div>

    </div>

  </div>

  <!-- Modal placeholder -->
  <div id="modalRoot" style="display:none;"></div>

  <!-- FIREBASE + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCWZSDq_ISBW3QNW9Qjl5n6CvpfIToCsxA",
      authDomain: "blisfull-wedding.firebaseapp.com",
      projectId: "blisfull-wedding",
      storageBucket: "blisfull-wedding.firebasestorage.app",
      messagingSenderId: "644097860130",
      appId: "1:644097860130:web:1bdb0002f7325a11ece07b",
      measurementId: "G-4JJQR6Z6PG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const messagesGrid = document.getElementById("messagesGrid");
    const counterEl = document.getElementById("counter");
    const searchInput = document.getElementById("search");
    const sortInput = document.getElementById("sort");
    const refreshBtn = document.getElementById("refreshNow");
    const modalRoot = document.getElementById("modalRoot");
    const themeTrack = document.getElementById("themeTrack");

    let allMessages = [];

    function getSecondsField(m){
      if(!m || !m.time) return 0;
      if (typeof m.time.seconds === "number") return m.time.seconds;
      if (m.time._seconds) return m.time._seconds;
      return 0;
    }

    async function loadMessages(){
      try {
        const colRef = collection(db, "messages");
        const snapshot = await getDocs(colRef);

        allMessages = [];
        snapshot.forEach(d => {
          const data = d.data();
          allMessages.push({
            id: d.id,
            ...data,
            time: data.time ? data.time : { seconds: 0 }
          });
        });

        renderMessages();
      } catch(err){
        console.error("Load error:", err);
      }
    }
    function renderMessages(){
      let data = [...allMessages];

      const q = searchInput.value.trim().toLowerCase();
      if(q){
        data = data.filter(m =>
          (m.name||"").toLowerCase().includes(q) ||
          (m.email||"").toLowerCase().includes(q) ||
          (m.message||"").toLowerCase().includes(q)
        );
      }

      if(sortInput.value === "latest"){
        data.sort((a,b) => getSecondsField(b) - getSecondsField(a));
      } else {
        data.sort((a,b) => getSecondsField(a) - getSecondsField(b));
      }

      counterEl.innerText = `Total: ${data.length}`;

      messagesGrid.innerHTML = "";
      if(data.length === 0){
        messagesGrid.innerHTML = `<div style="grid-column:1/-1; color:var(--muted); padding:20px;">No messages found.</div>`;
        return;
      }

      data.forEach(msg => {
        const dateText = getSecondsField(msg)
          ? new Date(getSecondsField(msg)*1000).toLocaleString()
          : "—";

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <h4>${escapeHtml(msg.name || "Unknown")}</h4>
          <div class="meta">${escapeHtml(msg.email || "—")} • ${escapeHtml(msg.phone || "—")}</div>
          <div class="small">${truncate(escapeHtml(msg.message || "—"), 160)}</div>

          <div class="actions">
            <div class="small">${dateText}</div>
            <div style="flex:1"></div>
            <button class="delete-btn" data-id="${msg.id}" title="Delete">Delete</button>
          </div>
        `;

        // modal open
        card.addEventListener("click", (e) => {
          if(e.target && e.target.matches(".delete-btn")) return;
          openModal(msg);
        });

        // delete
        const delBtn = card.querySelector(".delete-btn");
        delBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          if(!confirm("Delete this message?")) return;
          await deleteDoc(doc(db, "messages", msg.id));
          await loadMessages();
        });

        messagesGrid.appendChild(card);
      });
    }

    function truncate(str,n){
      if(!str) return "";
      return str.length > n ? str.slice(0,n) + "…" : str;
    }

    function escapeHtml(x){
      if(!x) return "";
      return x.replace(/[&<"'>]/g,m=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    /* ---------- MODAL ---------- */
    function openModal(msg){
      modalRoot.innerHTML = "";
      modalRoot.style.display = "flex";
      modalRoot.className = "modal-overlay";

      const modal = document.createElement("div");
      modal.className = "modal";

      const dateText = getSecondsField(msg)
        ? new Date(getSecondsField(msg)*1000).toLocaleString()
        : "—";

      modal.innerHTML = `
        <div class="modal-head">
          <div>
            <div style="font-family:'Playfair Display',serif;color:var(--gold);font-size:1.15rem;">
              ${escapeHtml(msg.name || "Unknown")}
            </div>
            <div style="color:var(--muted);font-size:0.95rem;">
              ${escapeHtml(msg.email || "—")} • ${escapeHtml(msg.phone || "—")}
            </div>
          </div>

          <div style="display:flex; gap:8px;">
            <button class="btn export-btn" id="pdfBtn">Download PDF</button>
            <button class="btn" id="replyBtn">Reply</button>
            <button class="delete-btn" id="delBtn">Delete</button>
            <button class="btn" id="closeModal">Close</button>
          </div>
        </div>

        <div class="modal-body">
          <div style="color:var(--muted); font-size:0.9rem; margin-bottom:10px;">${dateText}</div>
          <div style="white-space:pre-wrap; line-height:1.5;">${escapeHtml(msg.message || "")}</div>
        </div>

        <div class="modal-actions">
          <div style="color:var(--muted); font-size:0.9rem;">ID: ${msg.id}</div>
        </div>
      `;

      modalRoot.appendChild(modal);

      document.getElementById("closeModal").onclick = closeModal;

      document.getElementById("delBtn").onclick = async()=>{
        if(!confirm("Delete this message?")) return;
        await deleteDoc(doc(db,"messages",msg.id));
        closeModal();
        loadMessages();
      };

      document.getElementById("replyBtn").onclick = ()=>{
        window.location.href = `mailto:${encodeURIComponent(msg.email || "")}?subject=${encodeURIComponent("Regarding your message to Blissful Weddings")}`;
      };

      document.getElementById("pdfBtn").onclick = ()=>{
        downloadMessagePDF(msg);
      };

      modalRoot.onclick = (e)=>{ if(e.target===modalRoot) closeModal(); };
    }

    function closeModal(){
      modalRoot.style.display="none";
      modalRoot.innerHTML="";
    }

    /* ---------- PDF ---------- */
    async function downloadMessagePDF(msg){
      try {
        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF({ unit:"pt", format:"a4" });

        const margin = 40;
        let y = 60;

        docPDF.setFontSize(18);
        docPDF.text("Blissful Weddings — Message", margin, y);
        y += 30;

        docPDF.setFontSize(12);
        const date = getSecondsField(msg)
          ? new Date(getSecondsField(msg)*1000).toLocaleString()
          : "—";

        docPDF.text(`Name: ${msg.name || '—'}`, margin, y); y+=18;
        docPDF.text(`Email: ${msg.email || '—'}`, margin, y); y+=18;
        docPDF.text(`Phone: ${msg.phone || '—'}`, margin, y); y+=18;
        docPDF.text(`Date: ${date}`, margin, y); y+=24;

        docPDF.text(msg.message || "", margin, y);

        docPDF.save(`message-${msg.id}.pdf`);
      } catch(err){
        console.error("PDF error:", err);
        alert("PDF generation failed");
      }
    }

    /* ---------- EXPORTS ---------- */
    function downloadBlob(content, filename, type){
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([content],{type}));
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    window.exportCSV = function(){
      let csv = "Name,Email,Phone,Message,Date\n";
      allMessages.forEach(m=>{
        const dt = getSecondsField(m)
          ? new Date(getSecondsField(m)*1000).toLocaleString()
          : "";
        csv += `"${(m.name||"").replace(/"/g,'""')}",` +
               `"${(m.email||"").replace(/"/g,'""')}",` +
               `"${(m.phone||"").replace(/"/g,'""')}",` +
               `"${(m.message||"").replace(/"/g,'""')}",` +
               `"${dt}"\n`;
      });
      downloadBlob(csv,"messages.csv","text/csv");
    };

    window.exportJSON = function(){
      downloadBlob(JSON.stringify(allMessages,null,2),"messages.json","application/json");
    };

    window.exportTXT = function(){
      let txt = "";
      allMessages.forEach(m=>{
        const dt = getSecondsField(m)
          ? new Date(getSecondsField(m)*1000).toLocaleString()
          : "";
        txt += `Name: ${m.name}\nEmail: ${m.email}\nPhone: ${m.phone}\nDate: ${dt}\nMessage:\n${m.message}\n\n--------------------\n\n`;
      });
      downloadBlob(txt,"messages.txt","text/plain");
    };

    /* ---------- Theme toggle ---------- */
    function setThemeLight(flag){
      if(flag){
        document.body.classList.add("light");
        themeTrack.classList.add("active");
        localStorage.setItem("bw_theme","light");
      } else {
        document.body.classList.remove("light");
        themeTrack.classList.remove("active");
        localStorage.setItem("bw_theme","dark");
      }
    }

    themeTrack.addEventListener("click",()=>{
      const isActive = themeTrack.classList.contains("active");
      setThemeLight(!isActive);
    });

    const savedTheme = localStorage.getItem("bw_theme");
    setThemeLight(savedTheme==="light");

    /* ---------- INIT ---------- */
    searchInput.addEventListener("input", renderMessages);
    sortInput.addEventListener("change", renderMessages);
    refreshBtn.addEventListener("click", loadMessages);

    await loadMessages();
    setInterval(loadMessages,10000);

  </script>
<script>
  function logout(){
    localStorage.removeItem("adminLoggedIn");
    window.location.href = "login.html";
  }
</script>

</body>
</html>
